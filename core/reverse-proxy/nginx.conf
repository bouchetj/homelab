events { worker_connections 1024; }

http {
  # Upstreams for internal services
  upstream jellyfin_upstream   { server jellyfin:8096; }
  upstream jellyseerr_upstream { server jellyseerr:5055; }
  upstream glance_upstream     { server glance:8080; }
  upstream kavita_upstream     { server kavita:5000; }
  upstream pihole_upstream     { server pihole:80; }

  # Map subdomain -> upstream name
  map $host $upstream {
    default "";
    jellyfin.jubslab.org     jellyfin_upstream;
    jellyseerr.jubslab.org   jellyseerr_upstream;
    glance.jubslab.org       glance_upstream;
    kavita.jubslab.org       kavita_upstream;
    pihole.jubslab.org       pihole_upstream;
  }

  # Redirect all matching subdomains to HTTPS
  server {
    listen 80;
    server_name ~^([a-z0-9-]+)\.jubslab\.org$;
    return 301 https://$host$request_uri;
  }

  # HTTPS vhost for all internal subdomains (*.jubslab.org)
  server {
    listen 443 ssl;
    http2 on;
    server_name ~^([a-z0-9-]+)\.jubslab\.org$;

    # Use wildcard/SAN cert for jubslab.org
    ssl_certificate     /acme.sh/jubslab.org_ecc/fullchain.cer;
    ssl_certificate_key /acme.sh/jubslab.org_ecc/jubslab.org.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;

    # Restrict access to VPN/LAN only (adjust networks to your setup)
    allow 10.0.0.0/24;
    allow 192.168.86.0/24;
    deny all;

    # Return 404 if subdomain not mapped
    if ($upstream = "") { return 404; }

    location / {
      proxy_http_version 1.1;
      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Upgrade           $http_upgrade;
      proxy_set_header Connection        "upgrade";

      proxy_read_timeout 3600s;
      proxy_send_timeout 3600s;
      proxy_buffering off;
      client_max_body_size 0;

      proxy_pass http://$upstream;
    }
  }
}
